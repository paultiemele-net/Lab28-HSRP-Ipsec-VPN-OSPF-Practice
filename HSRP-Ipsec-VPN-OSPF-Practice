! ================================
! 3-Tier Network Architecture
! HSRP, OSPF, and IPsec VPN
! ================================

! ================================
! S1-L2 Switch (Access Layer - Site 1)
! ================================
vlan 10
 name IT
exit
vlan 20
 name HR
exit

int e0/0
 switchport mode access
 switchport access vlan 10
exit

int e0/1
 switchport mode access
 switchport access vlan 20
exit

int range e0/2-3
 switchport trunk encapsulation dot1q
 switchport mode trunk
exit

! ================================
! S2-L2 Switch (Access Layer - Site 1)
! ================================
vlan 10
 name IT
exit
vlan 20
 name HR
exit

int e0/0
 switchport mode access
 switchport access vlan 10
exit
int e0/1
 switchport mode access
 switchport access vlan 20
exit

int range e0/2-3
 switchport trunk encapsulation dot1q
 switchport mode trunk
exit

! ================================
! S1 L3 Core Switch (Site 1)
! ================================
vlan 10
 name IT
exit
vlan 20
 name HR
exit

int range e0/0-1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 no shut
exit

! VLAN Interfaces with HSRP
int vlan 10
 ip address 10.10.10.2 255.255.255.0
 standby 10 ip 10.10.10.1
 standby 10 priority 105
 standby 10 preempt
 no shut
exit

int vlan 20
 ip address 20.20.20.2 255.255.255.0
 standby 20 ip 20.20.20.1
 standby 20 priority 95
 standby 20 preempt
 no shut
exit

! Interface towards Router 1
int e0/2
 no switchport
 ip address 30.30.30.1 255.255.255.0
 no shut
exit

ip routing
router ospf 1
 network 10.10.10.0 0.0.0.255 area 0
 network 20.20.20.0 0.0.0.255 area 0
 network 30.30.30.0 0.0.0.255 area 0
exit

! ================================
! S2 L3 Core Switch (Site 1)
! ================================
int vlan 10
 ip address 10.10.10.5 255.255.255.0
 standby 10 ip 10.10.10.1
 standby 10 priority 95
 standby 10 preempt
 no shut
exit

int vlan 20
 ip address 20.20.20.5 255.255.255.0
 standby 20 ip 20.20.20.1
 standby 20 priority 105
 standby 20 preempt
 no shut
exit

int e0/2
 no switchport
 ip address 40.40.40.2 255.255.255.0
 no shut
exit

ip routing
router ospf 1
 network 10.10.10.0 0.0.0.255 area 0
 network 20.20.20.0 0.0.0.255 area 0
 network 40.40.40.0 0.0.0.255 area 0
exit

! ================================
! Router 1 (Site 1, VPN Endpoint)
! ================================
int f0/0
 ip address 30.30.30.1 255.255.255.0
 no shut
exit

int f0/1
 ip address 40.40.40.1 255.255.255.0
 no shut
exit

int f2/0
 ip address 50.50.50.1 255.255.255.0
 no shut
exit

router ospf 1
 network 30.30.30.0 0.0.0.255 area 0
 network 40.40.40.0 0.0.0.255 area 0
 network 50.50.50.0 0.0.0.255 area 0
exit

! IPsec VPN to Router 3
ip access-list extended VPN_R1_R3
 permit ip 10.10.10.0 0.0.0.255 90.90.90.0 0.0.0.255
 permit ip 20.20.20.0 0.0.0.255 100.100.100.0 0.0.0.255
exit

crypto isakmp policy 10
 encryption aes-256
 authentication pre-share
 group 5
exit

crypto isakmp key type1998 address 70.70.70.1
crypto ipsec transform-set VPN_SET esp-aes 256 esp-sha-hmac
crypto map VPN_MAP 10 ipsec-isakmp
 set peer 70.70.70.1
 set transform-set VPN_SET
 match address VPN_R1_R3

int f2/0
 crypto map VPN_MAP
exit

! ================================
! Router 3 (Site 2, VPN Endpoint)
! ================================
int f0/0
 ip address 70.70.70.1 255.255.255.0
 no shut
exit

int f0/1
 ip address 80.80.80.1 255.255.255.0
 no shut
exit

int f2/0
 ip address 60.60.60.1 255.255.255.0
 no shut
exit

router ospf 1
 network 70.70.70.0 0.0.0.255 area 0
 network 80.80.80.0 0.0.0.255 area 0
 network 60.60.60.0 0.0.0.255 area 0
exit

! IPsec VPN to Router 1
ip access-list extended VPN_R3_R1
 permit ip 90.90.90.0 0.0.0.255 10.10.10.0 0.0.0.255
 permit ip 100.100.100.0 0.0.0.255 20.20.20.0 0.0.0.255
exit

crypto isakmp policy 10
 encryption aes-256
 authentication pre-share
 group 5
exit

crypto isakmp key type1998 address 50.50.50.1
crypto ipsec transform-set VPN_SET esp-aes 256 esp-sha-hmac
crypto map VPN_MAP 10 ipsec-isakmp
 set peer 50.50.50.1
 set transform-set VPN_SET
 match address VPN_R3_R1

int f2/0
 crypto map VPN_MAP
exit

! ================================
! S3 L3 Core Switch (Site 2)
! ================================
vlan 30
 name IT
exit
vlan 40
 name HR
exit

int range e0/0-1
 switchport trunk encapsulation dot1q
 switchport mode trunk
 no shut
exit

int vlan 30
 ip address 90.90.90.2 255.255.255.0
 standby 30 ip 90.90.90.1
 standby 30 priority 105
 standby 30 preempt
 no shut
exit

int vlan 40
 ip address 100.100.100.2 255.255.255.0
 standby 40 ip 100.100.100.1
 standby 40 priority 95
 standby 40 preempt
 no shut
exit

int e0/2
 no switchport
 ip address 70.70.70.2 255.255.255.0
 no shut
exit

ip routing
router ospf 1
 network 70.70.70.0 0.0.0.255 area 0
 network 90.90.90.0 0.0.0.255 area 0
 network 100.100.100.0 0.0.0.255 area 0
exit

! ================================
! Site 1 PCs - Gateway is HSRP virtual IP
! ================================
PC1: ip 10.10.10.3 255.255.255.0 GW 10.10.10.1
PC2: ip 20.20.20.3 255.255.255.0 GW 20.20.20.1
PC3: ip 10.10.10.4 255.255.255.0 GW 10.10.10.1
PC4: ip 20.20.20.4 255.255.255.0 GW 20.20.20.1

! ================================
! Site 2 PCs - Gateway is HSRP virtual IP
! ================================
PC5: ip 90.90.90.3 255.255.255.0 GW 90.90.90.1
PC6: ip 100.100.100.3 255.255.255.0 GW 100.100.100.1
PC7: ip 90.90.90.4 255.255.255.0 GW 90.90.90.1
PC8: ip 100.100.100.4 255.255.255.0 GW 100.100.100.1

! ================================
! Verification Commands
! ================================
show standby
show ip ospf neighbor
show ip route ospf
show crypto isakmp sa
show crypto ipsec sa
ping 90.90.90.3
ping 100.100.100.4
ping 10.10.10.3
ping 20.20.20.4
